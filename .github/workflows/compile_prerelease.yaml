name: compile_prerelease
on:
  push:
    branches:
      - master
  workflow_dispatch:
jobs:
  compile:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Compile MicMute
        id: compile_micmute
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -scope CurrentUser -Force;
          Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
          scoop bucket add utils https://github.com/SaifAqqad/utils.git;
          scoop bucket add extras;
          scoop install extras/autohotkey utils/ahk2exe_beta main/upx;
          echo "Copying upx"
          Copy-Item -Path "$(scoop prefix upx)\upx.exe" -Destination "$(scoop prefix autohotkey)\Compiler\"
          echo "Running Ahk2Exe";
          Invoke-Expression "$(scoop prefix autohotkey)\Compiler\Ahk2Exe.exe /Silent /in '.\src\MicMute.ahk' /out '.\MicMute.exe' /bin `"$(scoop prefix autohotkey)\Compiler\Unicode 64-bit.bin`"  /compress '2' /Verbose 2>&1 | echo";
          echo "Calculating SHA256 hash";
          (Get-FileHash '.\MicMute.exe').Hash | Out-File -FilePath .\MicMute.sha256.txt
      
      - name: Create release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest_commit"
          prerelease: true
          title: "Development Build"
          files: |
            *.exe
            *.txt