name: compile_prerelease
on:
  workflow_dispatch:
jobs:
  compile:
    runs-on: windows-latest
    steps:

      - uses: actions/checkout@v2
      
      - name: Recreate release
        id: recreate_release
        uses: GongT/actions-recreate-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: latest_commit
          release_name: Build at latest commit
          draft: false
          prerelease: true
      
      - name: Build artifacts
        id: build_artifacts
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -scope CurrentUser -Force;
          Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
          scoop bucket add extras;
          scoop install autohotkey;
          echo "Running Ahk2Exe";
          & "$(scoop prefix autohotkey)\Compiler\Ahk2Exe.exe /in '.\src\MicMute.ahk' /out '.\src\out\MicMute.exe' /icon '.\src\MicMute.ico' | more;"
          echo "Finished with $LASTEXITCODE";
      - name: Upload release artifacts
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.recreate_release.outputs.upload_url }} 
          asset_path: ./src/out/MicMute.exe
          asset_name: MicMute.exe
          asset_content_type: application/octet-stream
